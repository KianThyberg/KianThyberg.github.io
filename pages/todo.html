<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>To Do List</title>
        <link rel="stylesheet" href="../stylesheets/style.css">
    </head>
    <body>
        <h1>To-Do List:</h1>
        <p>
            Plan out your day with a To-Do List. Come back later to find it right where
            you left it! Click "Complete Task" to remove them.
        </p>

        <h3 id="sessionCount"></h3>

        <button onclick="clearStorage()">Clear Storage</button>

        <label for="taskInput">Enter your task here: </label>
        <input type="text" id="taskInput">
        <button id="submit" onclick="createTask()">Enter task</button>

        <div id="listArea"></div>

        <p id="dupeWarning" class="feedback fadeInText"></p>

        <script>
            document.getElementById("listArea").addEventListener("click", (event) => {
                if (event.target.classList.contains("deleteable")){
                    removeLocalStorage(event.target.parentNode.textContent);
                    console.log(event.target.parentNode.textContent);
                    document.getElementById("listArea").removeChild(event.target.parentNode.parentNode);
                }
            });

            document.getElementById("taskInput").addEventListener("input", (event) => {
                document.getElementById("dupeWarning").textContent = "";
            });

            window.onload = function(){
                let currentStorage = JSON.parse(localStorage.getItem("tasks"));
                if (currentStorage){
                    let listArea = document.getElementById("listArea");
                    for (let task of currentStorage){
                        let newTaskDiv = document.createElement("div");
                        newTaskDiv.innerHTML += "<p>" + task + " <button class=\"deleteable\">Complete Task!</button></p>";

                        listArea.appendChild(newTaskDiv);

                        document.getElementById("taskInput").value = "";
                    }
                }
                let currentCount = sessionStorage.getItem("count");
                if (currentCount){
                    document.getElementById("sessionCount").textContent = currentCount + " tasks have been created in this session.";
                }
                else {
                    document.getElementById("sessionCount").textContent = "0 tasks have been created in this session.";
                }
            }

            function clearStorage(){
                localStorage.removeItem("tasks");
                window.location.reload();
            }

            function createTask(){
                let task = sanitizeString(document.getElementById("taskInput").value);
                if (task){
                    if (!checkTaskDuplicate(task)){
                        let listArea = document.getElementById("listArea");
                        let newTaskDiv = document.createElement("div");

                        newTaskDiv.innerHTML += "<p>" + task + " <button class=\"deleteable\">Complete Task!</button></p>";

                        console.log(newTaskDiv);    
                        listArea.appendChild(newTaskDiv);

                        document.getElementById("taskInput").value = "";

                        addLocalStorage(task);

                        let currentCount = sessionStorage.getItem("count");
                        if (currentCount){
                            currentCount++;
                            sessionStorage.setItem("count", currentCount);
                        }
                        else{
                            sessionStorage.setItem("count", 1);
                        }
                        document.getElementById("sessionCount").textContent = currentCount + " tasks have been created in this session.";
                    }
                    else {
                        document.getElementById("dupeWarning").textContent = "Duplicate tasks not allowed.";
                    }
                }
            }

            function addLocalStorage(task){
                let currentStorage = JSON.parse(localStorage.getItem("tasks"));
                if (!currentStorage){
                    currentStorage = [];
                }
                currentStorage.push(task);
                localStorage.setItem("tasks", JSON.stringify(currentStorage));
            }

            function removeLocalStorage(task){
                let taskText = getTextFromTask(task);
                let currentStorage = JSON.parse(localStorage.getItem("tasks"));
                console.log(currentStorage);
                console.log(taskText);
                if (currentStorage){
                    if (currentStorage.includes(taskText)){
                        currentStorage.splice(currentStorage.indexOf(taskText), 1);
                    }
                    localStorage.setItem("tasks", JSON.stringify(currentStorage));
                }
            }

            function checkTaskDuplicate(task){
                let currentStorage = JSON.parse(localStorage.getItem("tasks"));
                if (currentStorage){
                    return currentStorage.includes(task);
                }
                return false;
            }

            // Takes the content of a task from the list and returns only the text
            function getTextFromTask(taskContent){
                return taskContent.slice(0, taskContent.length - " Complete Task!".length)
            }

            // generic function to replace " ' < > & with sanitized characters
            function sanitizeString(string){
                return string.replace(/</g, "&lt").replace(/>/g, "&gt").replace(/"/, "&quot").replace(/'/, "&apos").replace(/&/, "&amp");
            }
        </script>
    </body>
</html>